<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Look</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .navbar {
      background-color: #ffffff;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }
    .navbar-brand img {
      height: 40px;
      object-fit: contain;
    }
    .notification-dropdown {
      max-height: 300px;
      overflow-y: auto;
    }

    .user-profile {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }
    .user-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
    }
    .user-details {
      flex-grow: 1;
    }
    .user-details h2 {
      margin: 0;
      font-size: 1.8rem;
    }
    .user-details p {
      margin: 5px 0;
      color: #666;
    }
    .user-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    .user-stats div {
      text-align: center;
    }
    .user-stats span {
      display: block;
      font-weight: bold;
      font-size: 1.2rem;
    }
    /* Styles for the application */
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    .post-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #ffffff;
      padding: 10px;
      margin: 10px;
    }
    .layer-list {
      list-style: none;
      padding: 0;
    }
    .layer-list li {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .layer-list img {
      border-radius: 50%;
      margin-right: 10px;
    }
    .modal-body {
      display: flex;
      flex-direction: column;
    }
    .canvas-container {
      width: 100%;
      margin-bottom: 20px;
    }
    .comments-container {
      width: 100%;
      overflow-y: auto;
      max-height: 300px;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .comment img {
      border-radius: 50%;
      margin-right: 10px;
    }
    .comment p {
      margin: 0;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 10px;
      gap: 10px;
    }
    .toolbar input[type="color"],
    .toolbar input[type="range"] {
      height: 38px;
    }
    .toolbar button {
      flex: 1 1 auto;
    }
    .toolbar .btn-group {
      flex: 1 1 auto;
    }
    @media (min-width: 768px) {
      .modal-body {
        flex-direction: row;
      }
      .canvas-container {
        flex: 2;
        margin-right: 20px;
      }
      .comments-container {
        flex: 1;
        max-height: none;
      }
    }
    canvas {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="images/logo.png" alt="Logo">
      </a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            id="notificationDropdown"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            Notifications
          </a>
          <ul
            class="dropdown-menu dropdown-menu-end notification-dropdown"
            aria-labelledby="notificationDropdown"
            id="notification-list"
          >
            <!-- Notifications will be loaded here -->
          </ul>
        </li>
      </ul>
    </div>
  </nav>
  <div class="container mt-4">
    <div class="user-profile">
      <img src="images/avatar_you.jpg" alt="User Avatar">
      <div class="user-details">
        <h2>Ahmad Hemmati</h2>
        <p>Associate Professor</p>
        <p>Bergen, Norway</p>
        <div class="user-stats">
          <div>
            <span>120</span>
            Posts
          </div>
          <div>
            <span>350</span>
            Followers
          </div>
          <div>
            <span>180</span>
            Following
          </div>
          <div>
            <span>32</span>
            Groups
          </div>
        </div>
      </div>
    </div>
    <!-- Feed Section -->
    <div id="feed-list" class="row g-3 justify-content-center"></div>
  </div>

  <!-- Post Modal -->
  <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Post Layers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="canvas-container">
            <canvas id="layer-preview"></canvas>
            <ul id="layer-list" class="layer-list"></ul>
          </div>
          <div class="comments-container" id="comments-container">
            <h5>Comments</h5>
            <div id="comments-body"></div>
            <div class="mt-3">
              <textarea id="comment-input" class="form-control mb-2" placeholder="Add a comment"></textarea>
              <button id="add-comment" class="btn btn-primary">Submit Comment</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Layer Modal -->
  <div class="modal fade" id="addLayerModal" tabindex="-1" aria-labelledby="addLayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Your Layer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Canvas and Toolbar -->
          <div class="canvas-container">
            <!-- Toolbar -->
            <div class="toolbar">
              <div class="btn-group" role="group">
                <button id="brush-tool" class="btn btn-outline-secondary active">Brush</button>
                <button id="eraser-tool" class="btn btn-outline-secondary">Eraser</button>
                <button id="rectangle-tool" class="btn btn-outline-secondary">Rectangle</button>
                <button id="circle-tool" class="btn btn-outline-secondary">Circle</button>
              </div>
              <input type="color" id="color-picker" value="#000000">
              <input type="range" id="brush-size" min="1" max="50" value="5">
              <button id="undo-button" class="btn btn-outline-secondary">Undo</button>
              <button id="redo-button" class="btn btn-outline-secondary">Redo</button>
            </div>
            <!-- Canvas -->
            <canvas id="canvas-stage"></canvas>
          </div>
          <button id="save-layer" class="btn btn-success mt-3">Save Layer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Sample user data with local avatar images
    const sampleUsers = [
      { name: "Alice", avatar: "images/avatar1.jpg" },
      { name: "Bob", avatar: "images/avatar2.jpg" },
      { name: "Charlie", avatar: "images/avatar3.jpg" },
      { name: "Diana", avatar: "images/avatar4.jpg" },
      { name: "Eve", avatar: "images/avatar5.jpg" },
      { name: "Frank", avatar: "images/avatar6.jpg" },
      { name: "Grace", avatar: "images/avatar7.jpg" },
      { name: "Hank", avatar: "images/avatar8.jpg" },
      { name: "Ivy", avatar: "images/avatar9.jpg" },
      { name: "Jack", avatar: "images/avatar10.jpg" },
      { name: "Kate", avatar: "images/avatar11.jpg" },
      { name: "Leo", avatar: "images/avatar12.jpg" },
    ];

    // Generate random comments
    const sampleComments = [
      "Amazing!",
      "Great work!",
      "Love this!",
      "So creative!",
      "Well done!",
      "Impressive!",
      "Fantastic!",
      "Brilliant!",
      "Superb!",
      "Awesome!",
    ];

    // Feed Data with 10 posts using local images
    const feed = Array.from({ length: 10 }, (_, i) => {
      const user = sampleUsers[i % sampleUsers.length];
      return {
        id: i + 1,
        user: user.name,
        avatar: user.avatar,
        image: `images/image${i + 1}.jpg`,
        caption: `Post ${i + 1} by ${user.name}`,
        comments: generateRandomCommentsWithUsers(),
      };
    });

    let activePost = null;
    let currentUser = { name: "You", avatar: "images/avatar_you.jpg" };

    function populateFeed() {
      const feedList = document.getElementById("feed-list");
      feedList.innerHTML = "";
      feed.forEach((post) => {
        const postCard = document.createElement("div");
        postCard.className = "col-12 col-md-6 col-lg-4";
        postCard.innerHTML = `
          <div class="post-card">
            <div class="d-flex align-items-center mb-2">
              <img src="${post.avatar}" alt="${post.user}" class="rounded-circle me-2" width="40" height="40">
              <strong>${post.user}</strong>
            </div>
            <img src="${post.image}" alt="${post.caption}" class="w-100 rounded mb-2" style="max-height: 300px; object-fit: cover;">
            <p>${post.caption}</p>
            <button class="btn btn-primary btn-sm" onclick="openPostModal(${post.id})">View Layers</button>
            
            <button class="btn btn-success btn-sm" onclick="openAddLayerModal(${post.id})">Add Layer</button>
            <button class="btn btn-outline-primary btn-sm" onclick="likePost(${post.id})">
              <i class="bi bi-heart"></i> Like
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="sharePost(${post.id})">
              <i class="bi bi-share"></i> Share
            </button>
          </div>
        `;
        feedList.appendChild(postCard);
      });
    }
    

  function likePost(postId) {
    alert(`Liked post ${postId}!`);
    // Implement a backend call to register the like
  }

  function sharePost(postId) {
    alert(`Shared post ${postId}!`);
    // Implement a backend call to handle sharing functionality
  }

    function openPostModal(postId) {
      activePost = feed.find((post) => post.id === postId);

      // Generate at least 10 random layers if not already generated
      if (!activePost.layers) {
        activePost.layers = generateRandomLayers(10);
      }

      const layerList = document.getElementById("layer-list");
      layerList.innerHTML = "";

      const canvas = document.getElementById("layer-preview");
      const ctx = canvas.getContext("2d");

      
      // Resize canvas
      // resizeCanvas(canvas);

      // Load the main image
      loadImageToCanvas(activePost.image, canvas, ctx, () => {
        // Show comments for the main picture
      displayComments(activePost.comments);

        // Set up comment submission
        document.getElementById("add-comment").onclick = () => {
          const commentInput = document.getElementById("comment-input");
          const commentText = commentInput.value.trim();
          if (commentText !== "") {
            const newComment = {
              user: currentUser.name,
              avatar: currentUser.avatar,
              text: commentText,
            };
            activePost.comments.push(newComment);
            displayComments(activePost.comments);
            commentInput.value = "";
          }
        };
      });

      // Display layers list
      activePost.layers.forEach((layer) => {
        const layerItem = document.createElement("li");
        layerItem.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="${layer.avatar}" alt="${layer.user}" width="30" height="30">
            <span>${layer.user}</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="viewLayer(${layer.id})">View</button>
        `;
        layerList.appendChild(layerItem);
      });

      const modal = new bootstrap.Modal(document.getElementById("postModal"));
      modal.show();

      // Handle window resize
      window.addEventListener('resize', () => resizeCanvas(canvas));
    }

    function loadImageToCanvas(imageSrc, canvas, ctx, callback) {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        if (callback) {
          // Delay the callback to ensure image rendering
          requestAnimationFrame(callback);
        }
      };
      img.onerror = () => {
        alert(`Failed to load image: ${imageSrc}`);
      };
      img.src = imageSrc;
    }

    function resizeCanvas(canvas) {
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth;
      const aspectRatio = 800 / 500; // Original image aspect ratio

      canvas.width = containerWidth;
      canvas.height = containerWidth / aspectRatio;
    }

    function generateRandomLayers(count) {
      const layers = [];
      for (let i = 0; i < count; i++) {
        const user = sampleUsers[Math.floor(Math.random() * sampleUsers.length)];
        layers.push({
          id: Date.now() + i,
          user: user.name,
          avatar: user.avatar,
          comments: generateRandomCommentsWithUsers(),
          data: generateRandomLayerData(),
        });
      }
      return layers;
    }

    function generateRandomCommentsWithUsers() {
      const comments = [];
      const count = Math.floor(Math.random() * 5) + 1;
      for (let i = 0; i < count; i++) {
        const user = sampleUsers[Math.floor(Math.random() * sampleUsers.length)];
        const commentText = sampleComments[Math.floor(Math.random() * sampleComments.length)];
        comments.push({
          user: user.name,
          avatar: user.avatar,
          text: commentText,
        });
      }
      return comments;
    }

    function generateRandomLayerData() {
      // Create a canvas to generate random drawings
      const canvas = document.createElement("canvas");
      canvas.width = 800;
      canvas.height = 500;
      const ctx = canvas.getContext("2d");

      // Generate random shapes
      const shapesCount = Math.floor(Math.random() * 5) + 1;
      for (let i = 0; i < shapesCount; i++) {
        ctx.fillStyle = getRandomColor();
        ctx.globalAlpha = Math.random() * 0.5 + 0.5;
        ctx.beginPath();
        ctx.arc(
          Math.random() * canvas.width,
          Math.random() * canvas.height,
          Math.random() * 50 + 20,
          0,
          2 * Math.PI
        );
        ctx.fill();
      }
      return canvas.toDataURL();
    }

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function viewLayer(layerId) {
      const layer = activePost.layers.find((l) => l.id === layerId);
      const canvas = document.getElementById("layer-preview");
      const ctx = canvas.getContext("2d");

      // Resize canvas
      resizeCanvas(canvas);

      // Load the main image
      loadImageToCanvas(activePost.image, canvas, ctx, () => {
        // Overlay the layer
        const layerImage = new Image();
        layerImage.onload = () => {
          ctx.drawImage(layerImage, 0, 0, canvas.width, canvas.height);

          // Show comments for the layer
          displayComments(layer.comments);

          // Set up comment submission for the layer
          document.getElementById("add-comment").onclick = () => {
            const commentInput = document.getElementById("comment-input");
            const commentText = commentInput.value.trim();
            if (commentText !== "") {
              const newComment = {
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: commentText,
              };
              layer.comments.push(newComment);
              displayComments(layer.comments);
              commentInput.value = "";
            }
          };
        };
        layerImage.src = layer.data;
      });

      // Handle window resize
      window.addEventListener('resize', () => resizeCanvas(canvas));
    }

    function displayComments(comments) {
      const commentsBody = document.getElementById("comments-body");
      commentsBody.innerHTML = "";
      comments.forEach((comment) => {
        const commentDiv = document.createElement("div");
        commentDiv.className = "comment";
        commentDiv.innerHTML = `
          <img src="${comment.avatar}" alt="${comment.user}" width="30" height="30">
          <div>
            <strong>${comment.user}</strong>
            <p>${comment.text}</p>
          </div>
        `;
        commentsBody.appendChild(commentDiv);
      });
    }

    function openAddLayerModal(postId) {
      activePost = feed.find((post) => post.id === postId);
      const modalElement = document.getElementById("addLayerModal");
      const modal = new bootstrap.Modal(modalElement);

      // Event listener for when the modal is fully shown
      modalElement.addEventListener('shown.bs.modal', () => {
        const canvas = document.getElementById("canvas-stage");
        const ctx = canvas.getContext("2d");

        // Resize canvas
        resizeCanvas(canvas);

        // Load the main image as background
        loadImageToCanvas(activePost.image, canvas, ctx, () => {
          initializeDrawingTools(ctx, canvas);
        });

        // Handle window resize
        window.addEventListener('resize', () => resizeCanvas(canvas));
      }, { once: true });

      modal.show();
    }

    function initializeDrawingTools(ctx, canvas) {
      let drawing = false;
      let tool = 'brush';
      let brushColor = '#000000';
      let brushSize = 5;
      let startX, startY;
      let history = [];
      let historyStep = -1;

      // Reset tool to brush
      selectTool('brush');

      // Remove existing event listeners to prevent stacking
      canvas.onmousedown = null;
      canvas.onmousemove = null;
      canvas.onmouseup = null;
      document.getElementById('undo-button').onclick = null;
      document.getElementById('redo-button').onclick = null;

      // Tool buttons
      document.getElementById('brush-tool').onclick = () => selectTool('brush');
      document.getElementById('eraser-tool').onclick = () => selectTool('eraser');
      document.getElementById('rectangle-tool').onclick = () => selectTool('rectangle');
      document.getElementById('circle-tool').onclick = () => selectTool('circle');

      // Color picker
      document.getElementById('color-picker').onchange = (e) => {
        brushColor = e.target.value;
      };

      // Brush size
      document.getElementById('brush-size').oninput = (e) => {
        brushSize = e.target.value;
      };

      // Undo/Redo buttons
      document.getElementById('undo-button').onclick = undo;
      document.getElementById('redo-button').onclick = redo;

      function selectTool(selectedTool) {
        tool = selectedTool;
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${selectedTool}-tool`).classList.add('active');
      }

      canvas.onmousedown = (e) => {
        drawing = true;
        startX = e.offsetX * (canvas.width / canvas.clientWidth);
        startY = e.offsetY * (canvas.height / canvas.clientHeight);
        if (tool === 'brush' || tool === 'eraser') {
          ctx.beginPath();
          ctx.moveTo(startX, startY);
        }
      };

      canvas.onmousemove = (e) => {
        if (!drawing) return;
        const currentX = e.offsetX * (canvas.width / canvas.clientWidth);
        const currentY = e.offsetY * (canvas.height / canvas.clientHeight);

        if (tool === 'brush') {
          ctx.strokeStyle = brushColor;
          ctx.lineWidth = brushSize;
          ctx.lineCap = 'round';
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        } else if (tool === 'eraser') {
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = brushSize;
          ctx.lineCap = 'round';
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        }
      };

      canvas.onmouseup = (e) => {
        if (!drawing) return;
        drawing = false;
        const endX = e.offsetX * (canvas.width / canvas.clientWidth);
        const endY = e.offsetY * (canvas.height / canvas.clientHeight);
        if (tool === 'rectangle' || tool === 'circle') {
          const width = endX - startX;
          const height = endY - startY;

          if (tool === 'rectangle') {
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.strokeRect(startX, startY, width, height);
          } else if (tool === 'circle') {
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.beginPath();
            ctx.ellipse(startX + width / 2, startY + height / 2, Math.abs(width / 2), Math.abs(height / 2), 0, 0, 2 * Math.PI);
            ctx.stroke();
          }
        }
        saveState();
      };

      function saveState() {
        history = history.slice(0, historyStep + 1);
        history.push(canvas.toDataURL());
        historyStep++;
      }

      function undo() {
        if (historyStep > 0) {
          historyStep--;
          restoreState(history[historyStep]);
        }
      }

      function redo() {
        if (historyStep < history.length - 1) {
          historyStep++;
          restoreState(history[historyStep]);
        }
      }

      function restoreState(dataURL) {
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = dataURL;
      }

      // Save initial state after the main image is loaded
      saveState();
    }

    document.getElementById("save-layer").onclick = () => {
      const canvas = document.getElementById("canvas-stage");
      const dataURL = canvas.toDataURL();

      // Add the new layer to the post
      if (!activePost.layers) {
        activePost.layers = [];
      }
      activePost.layers.push({
        id: Date.now(),
        user: currentUser.name,
        avatar: currentUser.avatar,
        comments: [],
        data: dataURL,
      });
      alert("Layer added!");
      const modal = bootstrap.Modal.getInstance(document.getElementById("addLayerModal"));
      modal.hide();
    };

    // Initialize the feed
    populateFeed();
  </script>
</body>
</html>
