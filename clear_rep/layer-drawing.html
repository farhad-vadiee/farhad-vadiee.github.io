<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Drawing with Konva.js</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/konva/8.3.3/konva.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .canvas-container {
      border: 2px solid #444;
      border-radius: 10px;
      margin-bottom: 20px;
      background-color: white;
    }
    .tools-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px;
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 10px;
    }
    .tools-bar .tool-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .layer-panel {
      max-height: 300px;
      overflow-y: auto;
    }
    .layer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .layer-item.active {
      background-color: #e9ecef;
      border-color: #007bff;
    }
    .layer-controls {
      display: flex;
      gap: 5px;
    }
    @media (max-width: 768px) {
      .tools-bar {
        flex-direction: column;
        gap: 15px;
      }
      .canvas-container {
        width: 100%;
        overflow: hidden;
      }
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">Collaborative Drawing with Konva.js</h1>

    <!-- Background Selection -->
    <div class="mb-4">
      <button id="blank-sheet" class="btn btn-primary">Start with Blank Sheet</button>
      <input type="file" id="upload-image" accept="image/*" class="btn btn-outline-secondary">
    </div>

    <!-- Toolbox -->
    <div class="tools-bar">
      <div class="tool-group">
        <button id="pencil-tool" class="btn btn-primary">
          <i class="bi bi-pencil"></i> Pencil
        </button>
        <button id="eraser-tool" class="btn btn-warning">
          <i class="bi bi-eraser"></i> Eraser
        </button>
      </div>
      <div class="tool-group">
        <input type="color" id="color-picker" value="#000000" class="form-control form-control-color" title="Choose Color">
        <input type="range" id="line-thickness" min="1" max="10" value="2" class="form-range" title="Brush Size">
      </div>
      <div class="tool-group">
        <button id="save-drawing" class="btn btn-success">Save Drawing</button>
        <button id="share-drawing" class="btn btn-info">Share Drawing</button>
      </div>
    </div>

    <!-- Canvas -->
    <div id="canvas-container" class="canvas-container">
      <div id="canvas-stage" style="width: 100%; height: 500px;"></div>
    </div>

    <!-- Layer Management -->
    <h3>Layers</h3>
    <ul id="layer-list" class="list-group"></ul>
    <button id="add-layer" class="btn btn-success mt-3">Add New Layer</button>

    <!-- Group Management -->
    <h3>Groups</h3>
    <div id="group-list" class="mb-3"></div>
    <input type="text" id="new-group-name" class="form-control mb-2" placeholder="New Group Name">
    <button id="add-group" class="btn btn-primary">Add Group</button>
  </div>

  <script>
    // Initialize Konva.js Stage
    const stage = new Konva.Stage({
      container: 'canvas-stage',
      width: 800,
      height: 500,
    });

    let layers = [];
    let activeLayer = null;
    let isDrawing = false;
    let backgroundLayer;
    let groups = [];

    // Add Background Layer
    function setBackground(imageSrc = null) {
      if (backgroundLayer) {
        stage.remove(backgroundLayer);
      }

      backgroundLayer = new Konva.Layer();
      stage.add(backgroundLayer);

      if (imageSrc) {
        const imageObj = new Image();
        imageObj.onload = function () {
          const bgImage = new Konva.Image({
            x: 0,
            y: 0,
            image: imageObj,
            width: stage.width(),
            height: stage.height(),
          });
          backgroundLayer.add(bgImage);
          backgroundLayer.draw();
        };
        imageObj.src = imageSrc;
      } else {
        backgroundLayer.draw(); // Blank sheet
      }
    }

    // Add a new layer
    function addLayer(name = `Layer ${layers.length + 1}`) {
      const layer = new Konva.Layer();
      layers.push({ layer, name, visible: true });
      stage.add(layer);
      setActiveLayer(layer);
      updateLayerList();
    }

    // Set Active Layer
    function setActiveLayer(layer) {
      activeLayer = layer;
      layers.forEach((l) => (l.layer.listening(false))); // Disable listening for other layers
      activeLayer.listening(true); // Enable listening for the active layer
      updateLayerList();
    }

    // Update Layer List UI
    function updateLayerList() {
      const layerList = document.getElementById('layer-list');
      layerList.innerHTML = '';
      layers.forEach((l, index) => {
        const layerItem = document.createElement('li');
        layerItem.className = `layer-item ${l.layer === activeLayer ? 'active' : ''}`;
        layerItem.innerHTML = `
          <span>${l.name}</span>
          <div class="layer-controls">
            <button class="btn btn-secondary btn-sm toggle-visibility">${l.visible ? 'Hide' : 'Show'}</button>
            <button class="btn btn-danger btn-sm delete-layer">Delete</button>
          </div>
        `;

        // Toggle Visibility
        layerItem.querySelector('.toggle-visibility').addEventListener('click', () => {
          l.visible = !l.visible;
          l.layer.visible(l.visible);
          stage.batchDraw();
          layerItem.querySelector('.toggle-visibility').textContent = l.visible ? 'Hide' : 'Show';
        });

        // Activate Layer
        layerItem.addEventListener('click', () => {
          setActiveLayer(l.layer);
        });

        // Delete Layer
        layerItem.querySelector('.delete-layer').addEventListener('click', () => {
          stage.remove(l.layer);
          layers.splice(index, 1);
          updateLayerList();
        });

        layerList.appendChild(layerItem);
      });
    }

    // Save Drawing
    document.getElementById('save-drawing').addEventListener('click', () => {
      const dataURL = stage.toDataURL();
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = 'drawing.png';
      link.click();
    });

    // Share Drawing
    document.getElementById('share-drawing').addEventListener('click', () => {
      const drawingData = stage.toJSON();
      console.log('Share this JSON data:', drawingData); // Implement backend logic here
      alert('Drawing shared successfully!');
    });

    // Group Management
    document.getElementById('add-group').addEventListener('click', () => {
      const groupName = document.getElementById('new-group-name').value.trim();
      if (groupName) {
        groups.push(groupName);
        updateGroupList();
        document.getElementById('new-group-name').value = '';
      }
    });

    function updateGroupList() {
      const groupList = document.getElementById('group-list');
      groupList.innerHTML = '';
      groups.forEach((group, index) => {
        const groupItem = document.createElement('div');
        groupItem.className = 'mb-2';
        groupItem.innerHTML = `
          <span>${group}</span>
          <button class="btn btn-danger btn-sm float-end" onclick="removeGroup(${index})">Remove</button>
        `;
        groupList.appendChild(groupItem);
      });
    }

    function removeGroup(index) {
      groups.splice(index, 1);
      updateGroupList();
    }

    // Pencil Tool
    document.getElementById('pencil-tool').addEventListener('click', () => {
      stage.off('mousedown mousemove mouseup');
      stage.on('mousedown', () => {
        isDrawing = true;
        const pos = stage.getPointerPosition();
        const line = new Konva.Line({
          stroke: document.getElementById('color-picker').value,
          strokeWidth: document.getElementById('line-thickness').value,
          points: [pos.x, pos.y],
          lineCap: 'round',
          lineJoin: 'round',
        });
        activeLayer.add(line);
        activeLayer.draw();
        stage.on('mousemove', () => {
          if (!isDrawing) return;
          const pos = stage.getPointerPosition();
          const points = line.points().concat([pos.x, pos.y]);
          line.points(points);
          activeLayer.draw();
        });
      });
      stage.on('mouseup', () => {
        isDrawing = false;
        stage.off('mousemove');
      });
    });

    // Eraser Tool
    document.getElementById('eraser-tool').addEventListener('click', () => {
      stage.off('mousedown mousemove mouseup');
      stage.on('mousedown', () => {
        const pos = stage.getPointerPosition();
        activeLayer.getChildren().forEach((shape) => {
          if (shape.intersects(pos)) {
            shape.destroy();
          }
        });
        activeLayer.draw();
      });
    });

    // Start with Blank Sheet
    document.getElementById('blank-sheet').addEventListener('click', () => {
      setBackground();
    });

    // Upload Image as Background
    document.getElementById('upload-image').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          setBackground(e.target.result);
        };
        reader.readAsDataURL(file);
      }
    });

    // Add New Layer Button
    document.getElementById('add-layer').addEventListener('click', () => {
      addLayer();
    });

    // Initialize with Default Blank Sheet and Layer
    setBackground();
    addLayer();
  </script>
</body>
</html>
