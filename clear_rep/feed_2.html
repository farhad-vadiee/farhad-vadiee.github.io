<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Layer Collaboration Demo with Enhanced Features</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    .post-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #ffffff;
      padding: 10px;
      margin: 10px;
    }
    .layer-list {
      list-style: none;
      padding: 0;
    }
    .layer-list li {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .layer-list img {
      border-radius: 50%;
      margin-right: 10px;
    }
    .modal-body {
      display: flex;
    }
    .canvas-container {
      flex: 2;
      margin-right: 20px;
    }
    .comments-container {
      flex: 1;
      overflow-y: auto;
      max-height: 500px;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .comment img {
      border-radius: 50%;
      margin-right: 10px;
    }
    .comment p {
      margin: 0;
    }
    .toolbar {
      display: flex;
      margin-bottom: 10px;
      gap: 10px;
    }
    .toolbar input[type="color"],
    .toolbar input[type="range"] {
      height: 38px;
    }
    .toolbar button {
      flex: 1;
    }
    .toolbar .btn-group {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center">Layer Collaboration Demo with Enhanced Features</h1>

    <!-- Feed Section -->
    <div id="feed-list" class="row g-3 justify-content-center"></div>
  </div>

  <!-- Post Modal -->
  <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- Changed to modal-xl for more space -->
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Post Layers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="canvas-container">
            <canvas id="layer-preview" width="800" height="500"></canvas>
            <ul id="layer-list" class="layer-list"></ul>
          </div>
          <div class="comments-container" id="comments-container">
            <h5>Comments</h5>
            <div id="comments-body"></div>
            <div class="mt-3">
              <textarea id="comment-input" class="form-control mb-2" placeholder="Add a comment"></textarea>
              <button id="add-comment" class="btn btn-primary">Submit Comment</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Layer Modal -->
  <div class="modal fade" id="addLayerModal" tabindex="-1" aria-labelledby="addLayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Your Layer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Toolbar -->
          <div class="toolbar">
            <div class="btn-group" role="group">
              <button id="brush-tool" class="btn btn-outline-secondary active">Brush</button>
              <button id="eraser-tool" class="btn btn-outline-secondary">Eraser</button>
              <button id="rectangle-tool" class="btn btn-outline-secondary">Rectangle</button>
              <button id="circle-tool" class="btn btn-outline-secondary">Circle</button>
            </div>
            <input type="color" id="color-picker" value="#000000">
            <input type="range" id="brush-size" min="1" max="50" value="5">
            <button id="undo-button" class="btn btn-outline-secondary">Undo</button>
            <button id="redo-button" class="btn btn-outline-secondary">Redo</button>
          </div>
          <canvas id="canvas-stage" width="800" height="500" style="border: 1px solid #ccc;"></canvas>
          <button id="save-layer" class="btn btn-success mt-3">Save Layer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include Bootstrap JS and Konva JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/konva/8.3.3/konva.min.js"></script>

  <script>
    // JavaScript code with enhanced features

    // Sample user data for random generation
    const sampleUsers = [
      { name: "Alice", avatar: "https://randomuser.me/api/portraits/women/1.jpg" },
      { name: "Bob", avatar: "https://randomuser.me/api/portraits/men/2.jpg" },
      { name: "Charlie", avatar: "https://randomuser.me/api/portraits/men/3.jpg" },
      { name: "Diana", avatar: "https://randomuser.me/api/portraits/women/4.jpg" },
      { name: "Eve", avatar: "https://randomuser.me/api/portraits/women/5.jpg" },
      { name: "Frank", avatar: "https://randomuser.me/api/portraits/men/6.jpg" },
      { name: "Grace", avatar: "https://randomuser.me/api/portraits/women/7.jpg" },
      { name: "Hank", avatar: "https://randomuser.me/api/portraits/men/8.jpg" },
      { name: "Ivy", avatar: "https://randomuser.me/api/portraits/women/9.jpg" },
      { name: "Jack", avatar: "https://randomuser.me/api/portraits/men/10.jpg" },
      { name: "Kate", avatar: "https://randomuser.me/api/portraits/women/11.jpg" },
      { name: "Leo", avatar: "https://randomuser.me/api/portraits/men/12.jpg" },
    ];

    // Generate random comments
    const sampleComments = [
      "Amazing!",
      "Great work!",
      "Love this!",
      "So creative!",
      "Well done!",
      "Impressive!",
      "Fantastic!",
      "Brilliant!",
      "Superb!",
      "Awesome!",
    ];

    // Feed Data with 10 posts
    const feed = Array.from({ length: 10 }, (_, i) => {
      const user = sampleUsers[i % sampleUsers.length];
      return {
        id: i + 1,
        user: user.name,
        avatar: user.avatar,
        image: `https://picsum.photos/seed/${i + 1}/600/400`,
        caption: `Post ${i + 1} by ${user.name}`,
        comments: generateRandomCommentsWithUsers(),
      };
    });

    let activePost = null;
    let currentUser = { name: "You", avatar: "https://randomuser.me/api/portraits/lego/1.jpg" };

    function populateFeed() {
      const feedList = document.getElementById("feed-list");
      feedList.innerHTML = "";
      feed.forEach((post) => {
        const postCard = document.createElement("div");
        postCard.className = "col-12 col-md-6 col-lg-4";
        postCard.innerHTML = `
          <div class="post-card">
            <div class="d-flex align-items-center mb-2">
              <img src="${post.avatar}" alt="${post.user}" class="rounded-circle me-2" width="40">
              <strong>${post.user}</strong>
            </div>
            <img src="${post.image}" alt="${post.caption}" class="w-100 rounded mb-2">
            <p>${post.caption}</p>
            <button class="btn btn-primary btn-sm" onclick="openPostModal(${post.id})">View Layers</button>
            <button class="btn btn-success btn-sm" onclick="openAddLayerModal(${post.id})">Add Layer</button>
          </div>
        `;
        feedList.appendChild(postCard);
      });
    }

    function openPostModal(postId) {
      activePost = feed.find((post) => post.id === postId);

      // Generate at least 10 random layers if not already generated
      if (!activePost.layers) {
        activePost.layers = generateRandomLayers(10);
      }

      const layerList = document.getElementById("layer-list");
      layerList.innerHTML = "";

      const canvas = document.getElementById("layer-preview");
      const ctx = canvas.getContext("2d");

      // Load the main image
      const mainImage = new Image();
      mainImage.crossOrigin = "Anonymous";
      mainImage.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mainImage, 0, 0, canvas.width, canvas.height);
      };
      mainImage.src = activePost.image;

      // Display layers list
      activePost.layers.forEach((layer) => {
        const layerItem = document.createElement("li");
        layerItem.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="${layer.avatar}" alt="${layer.user}" width="30">
            <span>${layer.user}</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="viewLayer(${layer.id})">View</button>
        `;
        layerList.appendChild(layerItem);
      });

      // Show comments for the main picture
      displayComments(activePost.comments);

      // Set up comment submission
      document.getElementById("add-comment").onclick = () => {
        const commentInput = document.getElementById("comment-input");
        const commentText = commentInput.value.trim();
        if (commentText !== "") {
          const newComment = {
            user: currentUser.name,
            avatar: currentUser.avatar,
            text: commentText,
          };
          activePost.comments.push(newComment);
          displayComments(activePost.comments);
          commentInput.value = "";
        }
      };

      const modal = new bootstrap.Modal(document.getElementById("postModal"));
      modal.show();
    }

    function generateRandomLayers(count) {
      const layers = [];
      for (let i = 0; i < count; i++) {
        const user = sampleUsers[Math.floor(Math.random() * sampleUsers.length)];
        layers.push({
          id: Date.now() + i,
          user: user.name,
          avatar: user.avatar,
          comments: generateRandomCommentsWithUsers(),
          data: generateRandomLayerData(),
        });
      }
      return layers;
    }

    function generateRandomCommentsWithUsers() {
      const comments = [];
      const count = Math.floor(Math.random() * 5) + 1;
      for (let i = 0; i < count; i++) {
        const user = sampleUsers[Math.floor(Math.random() * sampleUsers.length)];
        const commentText = sampleComments[Math.floor(Math.random() * sampleComments.length)];
        comments.push({
          user: user.name,
          avatar: user.avatar,
          text: commentText,
        });
      }
      return comments;
    }

    function generateRandomLayerData() {
      // Create a canvas to generate random drawings
      const canvas = document.createElement("canvas");
      canvas.width = 800;
      canvas.height = 500;
      const ctx = canvas.getContext("2d");

      // Generate random shapes
      const shapesCount = Math.floor(Math.random() * 5) + 1;
      for (let i = 0; i < shapesCount; i++) {
        ctx.fillStyle = getRandomColor();
        ctx.globalAlpha = Math.random() * 0.5 + 0.5;
        ctx.beginPath();
        ctx.arc(
          Math.random() * canvas.width,
          Math.random() * canvas.height,
          Math.random() * 50 + 20,
          0,
          2 * Math.PI
        );
        ctx.fill();
      }
      return canvas.toDataURL();
    }

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function viewLayer(layerId) {
      const layer = activePost.layers.find((l) => l.id === layerId);
      const canvas = document.getElementById("layer-preview");
      const ctx = canvas.getContext("2d");

      // Load the main image first
      const mainImage = new Image();
      mainImage.crossOrigin = "Anonymous";
      mainImage.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mainImage, 0, 0, canvas.width, canvas.height);

        // Overlay the layer
        const layerImage = new Image();
        layerImage.onload = () => {
          ctx.drawImage(layerImage, 0, 0, canvas.width, canvas.height);

          // Show comments for the layer
          displayComments(layer.comments);

          // Set up comment submission for the layer
          document.getElementById("add-comment").onclick = () => {
            const commentInput = document.getElementById("comment-input");
            const commentText = commentInput.value.trim();
            if (commentText !== "") {
              const newComment = {
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: commentText,
              };
              layer.comments.push(newComment);
              displayComments(layer.comments);
              commentInput.value = "";
            }
          };
        };
        layerImage.src = layer.data;
      };
      mainImage.src = activePost.image;
    }

    function displayComments(comments) {
      const commentsBody = document.getElementById("comments-body");
      commentsBody.innerHTML = "";
      comments.forEach((comment) => {
        const commentDiv = document.createElement("div");
        commentDiv.className = "comment";
        commentDiv.innerHTML = `
          <img src="${comment.avatar}" alt="${comment.user}" width="30">
          <div>
            <strong>${comment.user}</strong>
            <p>${comment.text}</p>
          </div>
        `;
        commentsBody.appendChild(commentDiv);
      });
    }

    function openAddLayerModal(postId) {
      activePost = feed.find((post) => post.id === postId);
      const modal = new bootstrap.Modal(document.getElementById("addLayerModal"));
      modal.show();

      const canvas = document.getElementById("canvas-stage");
      const ctx = canvas.getContext("2d");

      // Load the main image as background
      const mainImage = new Image();
      mainImage.crossOrigin = "Anonymous";
      mainImage.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mainImage, 0, 0, canvas.width, canvas.height);
        initializeDrawingTools(ctx, canvas, mainImage);
      };
      mainImage.src = activePost.image;
    }

    function initializeDrawingTools(ctx, canvas, backgroundImage) {
      let drawing = false;
      let tool = 'brush';
      let brushColor = '#000000';
      let brushSize = 5;
      let startX, startY;
      let history = [];
      let historyStep = -1;

      // Save initial state
      saveState();

      // Tool buttons
      document.getElementById('brush-tool').onclick = () => selectTool('brush');
      document.getElementById('eraser-tool').onclick = () => selectTool('eraser');
      document.getElementById('rectangle-tool').onclick = () => selectTool('rectangle');
      document.getElementById('circle-tool').onclick = () => selectTool('circle');

      // Color picker
      document.getElementById('color-picker').onchange = (e) => {
        brushColor = e.target.value;
      };

      // Brush size
      document.getElementById('brush-size').oninput = (e) => {
        brushSize = e.target.value;
      };

      // Undo/Redo buttons
      document.getElementById('undo-button').onclick = undo;
      document.getElementById('redo-button').onclick = redo;

      function selectTool(selectedTool) {
        tool = selectedTool;
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${selectedTool}-tool`).classList.add('active');
      }

      canvas.onmousedown = (e) => {
        drawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
        if (tool === 'brush' || tool === 'eraser') {
          ctx.beginPath();
          ctx.moveTo(startX, startY);
        }
      };

      canvas.onmousemove = (e) => {
        if (!drawing) return;
        const currentX = e.offsetX;
        const currentY = e.offsetY;

        if (tool === 'brush') {
          ctx.strokeStyle = brushColor;
          ctx.lineWidth = brushSize;
          ctx.lineCap = 'round';
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        } else if (tool === 'eraser') {
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = brushSize;
          ctx.lineCap = 'round';
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        }
      };

      canvas.onmouseup = (e) => {
        if (!drawing) return;
        drawing = false;
        if (tool === 'rectangle' || tool === 'circle') {
          const endX = e.offsetX;
          const endY = e.offsetY;
          const width = endX - startX;
          const height = endY - startY;

          if (tool === 'rectangle') {
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.strokeRect(startX, startY, width, height);
          } else if (tool === 'circle') {
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.beginPath();
            ctx.ellipse(startX, startY, Math.abs(width), Math.abs(height), 0, 0, 2 * Math.PI);
            ctx.stroke();
          }
        }
        saveState();
      };

      function saveState() {
        history = history.slice(0, historyStep + 1);
        history.push(canvas.toDataURL());
        historyStep++;
      }

      function undo() {
        if (historyStep > 0) {
          historyStep--;
          restoreState(history[historyStep]);
        }
      }

      function redo() {
        if (historyStep < history.length - 1) {
          historyStep++;
          restoreState(history[historyStep]);
        }
      }

      function restoreState(dataURL) {
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
        img.src = dataURL;
      }

      // Reset tool to brush
      selectTool('brush');
    }

    document.getElementById("save-layer").onclick = () => {
      const canvas = document.getElementById("canvas-stage");
      const dataURL = canvas.toDataURL();

      // Add the new layer to the post
      if (!activePost.layers) {
        activePost.layers = [];
      }
      activePost.layers.push({
        id: Date.now(),
        user: currentUser.name,
        avatar: currentUser.avatar,
        comments: [],
        data: dataURL,
      });
      alert("Layer added!");
      const modal = bootstrap.Modal.getInstance(document.getElementById("addLayerModal"));
      modal.hide();
    };

    populateFeed();
  </script>
</body>
</html>
